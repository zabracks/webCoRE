/*! smart-area 1.1.0 17-12-2015 */
angular.module("smartArea",[]).directive("smartArea",["$compile",function(a){return{restrict:"A",scope:{areaConfig:"=smartArea",areaData:"=ngModel"},replace:!0,link:function(b,c){if("textarea"!==c[0].tagName.toLowerCase())return console.warn("smartArea can only be used on textareas"),!1;var d=["direction","boxSizing","width","overflowX","overflowY","color","height","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","borderTopStyle","borderRightStyle","borderBottomStyle","borderLeftStyle","borderRadius","backgroundColor","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","whiteSpace","wordBreak","wordWrap"],e=angular.element('<div class="sa-wrapper"></div>');!(null===window.mozInnerScreenX);return b.fakeAreaElement=angular.element(a('<div class="sa-fakeArea" ng-trim="false" ng-bind-html="fakeArea"></div>')(b)).appendTo(e),b.dropdown.element=angular.element(a('<div class="sa-dropdown" ng-show="dropdown.content.length > 0"><input type="text" class="form-control" ng-show="dropdown.showFilter"/><ul class="dropdown-menu" role="menu" style="position:static"><li ng-repeat="element in dropdown.content" role="presentation"><a href="" role="menuitem" ng-click="dropdown.selected(element)" ng-class="{active: $index == dropdown.current}" ng-bind-html="element.display"></a></li></ul></div>')(b)).appendTo(e),b.dropdown.filterElement=b.dropdown.element.find("input"),b.dropdown.filterElement.bind("keydown",b.keyboardEvents),b.fakeAreaElement.css("whiteSpace","pre-wrap"),b.fakeAreaElement.css("wordWrap","break-word"),d.forEach(function(a){b.fakeAreaElement.css(a,c.css(a))}),b.fakeAreaElement.css("width",parseInt(c.outerWidth())+1+"px"),e.insertBefore(c),c.appendTo(e).addClass("sa-realArea").attr("ng-trim",!1),a(c),c.on("keyup",function(){b.fakeAreaElement.height(c.height())}),e},controller:["$scope","$element","$timeout","$sce",function(a,b,c,d){function e(d,e){a.dropdown.showFilter=!1;var f=a.areaData,h=k(),i=f.substr(0,h).split(/[(\s|\+|\-|\*|\/|\&|\||\^|\,|\(|\{|\])\b{}]/),j=i[i.length-1].length;!e&&a.dropdown.match&&(j=a.dropdown.match.length),(e||0>j)&&(j=0),a.areaData=f.substr(0,h-j)+d+f.substr(h),!e&&a.dropdown.match&&(h=h-a.dropdown.match.length+d.toString().length),b[0].selectionStart&&c(function(){b[0].focus(),b[0].setSelectionRange(h-j+d.toString().length,h-j+d.toString().length),g()},100)}function f(){var b=a.areaData;"undefined"!=typeof a.areaConfig.autocomplete&&0!==a.areaConfig.autocomplete.length&&(a.areaConfig.autocomplete.forEach(function(a){for(var c=0;c<a.words.length;c++)b="string"==typeof a.words[c]?b.replace(new RegExp("([^\\w]|\\b)("+a.words[c].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&")+")([^\\w]|\\b)","g"),'$1<span class="'+a.cssClass+'">$2</span>$3'):b.replace(a.words[c],function(b){return'<span class="'+a.cssClass+'">'+b+"</span>"})}),a.fakeArea=d.trustAsHtml(b))}function g(){j(),h()}function h(){a.dropdown.showFilter=!1,a.dropdown.match=!1,"undefined"!=typeof a.areaConfig.dropdown&&0!==a.areaConfig.dropdown.length&&a.areaConfig.dropdown.forEach(function(b){var e=a.areaData,f=k();if("string"==typeof b.trigger&&b.trigger===e.substr(f-b.trigger.length,b.trigger.length))b.list(function(e){a.dropdown.content=e.map(function(a){return a.display=d.trustAsHtml(a.display),a}),a.dropdown.customSelect=b.onSelect,a.dropdown.mode=b.mode||"append",a.dropdown.match="",a.dropdown.showFilter=b.filter||!1,c(function(){a.dropdown.filterElement.focus()},10)});else if("object"==typeof b.trigger){for(var g,h=e.substr(0,f),i=!1,j=0;null!==(g=b.trigger.exec(h))&&g.index!==j;)if(j=g.index,g.index+g[0].length===f){i=!0;break}i&&b.list(g,function(c){a.dropdown.content=c.map(function(a){return a.display=d.trustAsHtml(a.display),a}),a.dropdown.customSelect=b.onSelect,a.dropdown.mode=b.mode||"append",a.dropdown.match=g[1],a.dropdown.showFilter=b.filter||!1})}})}function i(){c(function(){a.fakeAreaElement.scrollTop(b.scrollTop())},5)}function j(){var b=[],c=[],e=a.areaData,f=k(),g=e.substr(0,f).split(/[(\s|\+|\-|\*|\/|\&|\||\^|\,|\(|\{|\])\b{}]/);g=g[g.length-1],a.areaConfig.autocomplete.forEach(function(a){a.words.forEach(function(c){"string"==typeof c&&b.indexOf(c)<0&&(g.length>0||g.length<1&&a.autocompleteOnSpace)&&b.push(c)})}),void 0!==a.areaConfig.dropdown&&a.areaConfig.dropdown.forEach(function(a){"string"==typeof a.trigger&&b.indexOf(a.trigger)<0&&b.push(a.trigger)}),b.forEach(function(a){g.length<a.length&&a.toLowerCase().substr(0,g.length)===g.toLowerCase()&&c.push({display:d.trustAsHtml(a),data:null})}),a.dropdown.customSelect=null,a.dropdown.current=0,a.dropdown.content=c}function k(){var a=b[0];return"number"==typeof a.selectionEnd?a.selectionEnd:void 0}a.fakeArea=a.areaData,a.dropdownContent="Dropdown",a.dropdown={content:[],element:null,current:0,select:null,customSelect:null,filter:"",match:"",mode:"append",showFilter:!1,filterElement:null},a.$watch("areaData",function(){a.trackCaret(),g()}),a.trackCaret=function(){var e=a.areaData,g=k();a.fakeArea=d.trustAsHtml(e.substring(0,g)+'<span class="sa-tracking"></span>'+e.substring(g)),c(function(){var c=a.fakeAreaElement.find("span.sa-tracking");if(c.length>0){var d=c.position();a.dropdown.element.css({top:d.top+parseInt(b.css("fontSize"))+2+"px",left:d.left+"px"})}f()},0)},a.keyboardEvents=function(d){if(a.dropdown.content.length>0){var e=d.keyCode||d.which;13===e?(d.preventDefault(),d.stopPropagation(),c(function(){a.dropdown.selected(a.dropdown.content[a.dropdown.current])},0)):38===e?(d.preventDefault(),d.stopPropagation(),c(function(){a.dropdown.current--,a.dropdown.current<0&&(a.dropdown.current=a.dropdown.content.length-1)},0)):40===e?(d.preventDefault(),d.stopPropagation(),c(function(){a.dropdown.current++,a.dropdown.current>=a.dropdown.content.length&&(a.dropdown.current=0)},0)):27===e?(d.preventDefault(),d.stopPropagation(),c(function(){a.dropdown.content=[],b[0].focus()},0)):a.dropdown.filterElement.focus()}},a.dropdown.selected=function(b){if(null!==a.dropdown.customSelect){var c="append"===a.dropdown.mode;e(a.dropdown.customSelect(b),c)}else e(b.display);a.dropdown.content=[]},b.bind("keyup click focus",function(){c(function(){a.trackCaret()},0)}),b.bind("keydown",function(b){i(),a.keyboardEvents(b)})}]}}]);

